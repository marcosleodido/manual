<script src="token.js"></script>
<script> 
const REPO_OWNER = "marcosleodido";
const REPO_NAME = "manual";
const BRANCH = "main";

// Função para enviar arquivo para o GitHub
async function uploadToGitHub(path, content) {
  const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}`;

  const response = await fetch(url, {
    method: "PUT",
    headers: {
      "Authorization": `Bearer ${GITHUB_TOKEN}`,
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      message: `Criar arquivo ${path}`,
      content: btoa(unescape(encodeURIComponent(content))),
      branch: BRANCH
    })
  });

  return response.json();
}

document.getElementById("postForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const title = document.getElementById("title").value.trim();
  const tags = document.getElementById("tags").value.trim().split(",").map(t => t.trim());
  const content = document.getElementById("content").value.trim();
  const imageFile = document.getElementById("image").files[0];

  const filename = title.toLowerCase().replace(/ /g, "-") + ".json";
  const postPath = `posts/${filename}`;

  const postData = {
    title,
    tags,
    content,
    image: imageFile ? imageFile.name : null,
    date: new Date().toISOString()
  };

  // 1) Criar arquivo do tutorial
  await uploadToGitHub(postPath, JSON.stringify(postData, null, 2));

  // 2) Se tiver imagem, fazer upload dela
  if (imageFile) {
    const imgBuffer = await imageFile.arrayBuffer();
    const base64Image = btoa(
      new Uint8Array(imgBuffer).reduce((data, byte) => data + String.fromCharCode(byte), "")
    );

    await uploadToGitHub(`posts/${imageFile.name}`, base64Image);
  }

  alert("Tutorial publicado com sucesso!");
});
</script>
