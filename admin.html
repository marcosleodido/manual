<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel Admin</title>
  <script src="token.js"></script>
</head>
<body>
  <h1>Painel Admin</h1>

  <form id="postForm">
    <label for="title">Título:</label>
    <input type="text" id="title" placeholder="Digite o título" required>

    <label for="tags">Tags (separadas por vírgula):</label>
    <input type="text" id="tags" placeholder="ex: icms, ncm, fiscal">

    <label for="content">Conteúdo:</label>
    <textarea id="content" placeholder="Digite o conteúdo" required></textarea>

    <label for="image">Imagem:</label>
    <input type="file" id="image" accept="image/*">

    <button type="submit">Publicar Tutorial</button>
  </form>

  <script>
    const REPO_OWNER = "marcosleodido";
    const REPO_NAME = "manual";
    const BRANCH = "main";

    async function uploadToGitHub(path, content) {
      const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}`;
      const resp = await fetch(url, {
        method: "PUT",
        headers: { 
          "Authorization": `Bearer ${GITHUB_TOKEN}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: `Criar arquivo ${path}`,
          content: btoa(unescape(encodeURIComponent(content))),
          branch: BRANCH
        })
      });
      return resp.json();
    }

    async function updateIndexJson(filename) {
      const resp = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/posts/index.json`);
      const data = await resp.json();
      const content = JSON.parse(atob(data.content));

      content.push(filename); // adiciona novo tutorial
      await uploadToGitHub('posts/index.json', JSON.stringify(content, null, 2));
    }

    document.getElementById("postForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const title = document.getElementById("title").value.trim();
      const tags = document.getElementById("tags").value.split(",").map(t => t.trim());
      const content = document.getElementById("content").value.trim();
      const imageFile = document.getElementById("image").files[0];

      const filename = title.toLowerCase().replace(/ /g, "-") + ".json";

      const postData = {
        title,
        tags,
        content,
        image: imageFile ? imageFile.name : null,
        date: new Date().toISOString()
      };

      // 1️⃣ Criar arquivo JSON do tutorial
      await uploadToGitHub(`posts/${filename}`, JSON.stringify(postData, null, 2));

      // 2️⃣ Fazer upload da imagem
      if (imageFile) {
        const imgBuffer = await imageFile.arrayBuffer();
        const base64Image = btoa(
          new Uint8Array(imgBuffer).reduce((data, byte) => data + String.fromCharCode(byte), "")
        );
        await uploadToGitHub(`posts/${imageFile.name}`, base64Image);
      }

      // 3️⃣ Atualizar index.json
      await updateIndexJson(filename);

      alert("Tutorial publicado com sucesso!");
    });
  </script>
</body>
</html>
